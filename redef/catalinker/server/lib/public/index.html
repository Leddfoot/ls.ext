<!DOCTYPE html>
<html>
  <head>
  	<meta charset="utf-8">
    <title>Katalogisering</title>
    <style type="text/css">
      *           { box-sizing: border-box; }
      body        { margin: 40px auto; max-width: 1050px; line-height: 1.6; padding: 0 10px;
                    font-family: sans-serif; font-size: 18px; color: #222; }
      h1, h2, h3  { line-height: 1.2 }
      fieldset    { border: 0; background: #eee;}
      input       { width: 300px; padding: 3px; margin: 0 }
      label       { font-family: monospace; text-align: right; width: 160px; display: inline-block; }

      #errors     { background: #F77F00; color: #fff; font-weight: bold; }
      #errors p   { padding: 4px; }

      #save-stat  { text-align: right; color: #888; margin: 0 4px; display: block; }
      #save-stat:before  { content: "status: ";}

      .prop-input   { clear:both ;}
      .prop-details { width: 20%; float: left; text-align: right;}
      .prop-values  { padding-left: 1em; max-width: 80%; float:left;}

      .invalid-input { border: 1px solid #F77F00;}
      .invalid-msg   { color: #F77F00; font-size: 12px;}

    </style>
    <script src="lib.js"></script>
  </head>
  <body>
    <div id="#container"></div>
    <script id="template" type="text/ractive">
      <h2>Katalogisering av verk</h2>
      <div id="errors">{{#errors}}<p>{{.}}</p>{{/errors}}</div>
      <div id="save-stat">{{save_status}}</div>
      <fieldset>
        <div class="prop-input">
          <div class="prop-details">
            <label>URI</label>
          </div>
          <div class="prop-values">
            <input disabled="disabled" data-automation-id="work_uri" value="{{work_uri}}"/>
          </div>
        </div>
        {{#each inputs}}
          <div class="prop-input {{predicate}}">
            <div class="prop-details">
              <button on-click="addValue">+</button>
              <label>{{label}}</label>
            </div>
            <div class="prop-values">
              {{#each values}}
                {{#range === "http://www.w3.org/2001/XMLSchema#string"}}
                  {{>input-lang-string}}
                {{elseif range === "http://www.w3.org/2001/XMLSchema#gYear"}}
                  {{>input-gYear}}
                {{elseif range === "http://www.w3.org/2001/XMLSchema#nonNegativeInteger"}}
                  {{>input-nonNegativeInteger}}
                {{else}}
                  {{>input-string}}
                {{/}}
                <br/>
                <div class="invalid-msg">{{#error}}{{error}}{{/error}}</div>
              {{/each}}
            </div>
          </div>
        {{/each}}
      </fieldset>

      {{#partial input-string}}
          <input
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            on-change="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
      {{/partial}}

      {{#partial input-lang-string}}
          <input
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            on-change="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
            {{#range === "http://www.w3.org/2001/XMLSchema#string"}}
              <select value="{{current.lang}}"
                      on-change='patchResource:{{predicate}}'
                      class="select_lang">
                <option value="">velg språk</option>
                <option value="no">norsk</option>
                <option value="en">engelsk</option>
                <option value="fr">fransk</option>
              </select>
            {{/}}
      {{/partial}}

      {{#partial input-gYear}}
          <input
            class="{{#error}}invalid-input{{else}}valid{{/error}}"
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
      {{/partial}}

      {{#partial input-nonNegativeInteger}}
          <input
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            on-change="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
      {{/partial}}
    </script>
    <script src="http://cdn.ractivejs.org/latest/ractive.min.js"></script>
    <script>
      var errors = [];
      var ractive = new Ractive({
        el: "#container",
        lang: "no",
        template: "#template",
        data: {
          errors: errors,
          work_uri: "",
          inputs: {},
          ontology: null,
          save_status: "nytt verk"
        },
      });

      // Event handling functions responding to UI interactions:
      listener = ractive.on({
        countdownToSave: function( event ) {
          // TODO find better name to this function
          if ( event.context.current.value === "" && event.context.old.value === "" ) {
            return;
          }
          ractive.set("save_status", "arbeider...");
        },
        // addValue adds another input field for the predicate.
        addValue: function( event ) {
          ractive.get( event.keypath ).values.push({
            old: { value: "", type: "", lang: "" },
            current: { value: "", type: "", lang: "" }
          });
        },
        // patchResource creates a patch request based on previous and current value of
        // input field, and sends this to the backend.
        patchResource: function( event, predicate ) {
          if ( event.context.error || (event.context.current.value === "" && event.context.old.value === "" ) ) {
            return;
          }
          var patch = rdf.createPatch( ractive.get("work_uri"), predicate, event.context );
          http.patch(ractive.get("work_uri"), patch,
            function( response) {
              // successfully patched resource

              // keep the value in current.old - so we can do create delete triple patches later
              var cur = ractive.get(event.keypath+".current");
              ractive.set( event.keypath+".old.value", cur.value );
              ractive.set( event.keypath+".old.lang", cur.lang );
              ractive.set( event.keypath+".old.datatype", cur.datatypr );

              ractive.set("save_status", "alle endringer er lagret");
            },
            function( response) {
              // failed to patch resource
              errors.push( "Noe gikk galt! Fikk ikke lagret endringene" )
            });
        }
      });

      // Observing input for instant validation:
      ractive.observe("inputs.*.values.*", function(newValue, oldValue, keypath) {
        if ( newValue.current.value === "" ) {
          ractive.set( keypath+".error", false );
          return;
        }
        var parent = keypath.substr(0, keypath.substr(0,keypath.lastIndexOf(".")).lastIndexOf("."));
        var valid = false;
        try {
          valid = rdf.validateLiteral(newValue.current.value, ractive.get(parent).range);
        } catch (e) {
          console.log(e);
          return;
        }
        if (valid ) {
          ractive.set( keypath+".error", false );
        } else {
          ractive.set( keypath+".error", "ugyldig input" );
        }
      });

      // Application entrypoint - will fetch any resources (ontology etc) required to populate the UI.
      http.get("/config",
        function( response ) {
          cfg = JSON.parse( response.responseText );

          // fetch ontology
          http.get(cfg.ontologyUri,
            function( response ) {
              var ontology = JSON.parse( response.responseText ),
                  props = rdf.propsByClass( ontology, "Work" ),
                  inputs = [];

              ractive.set( "ontology", ontology );

              for ( var i=0; i<props.length; i++ ) {
                inputs.push({
                  predicate: rdf.resolveURI( ontology,  props[i]["@id"]),
                  range: props[i]["rdfs:range"]["@id"],
                  label:props[i]["rdfs:label"][0]["@value"],
                  values: [{old: { value: "", type: "", lang: "" },
                            current: { value: "", type: "", lang: "" }}]
                });
              }
              ractive.set( "inputs", inputs );
            },
           function( response ) {
             console.log( "GET ontology error: " + response );
          });

         // fetch URI for work
         http.post(cfg.resourceApiUri + "work", "{}",
           function( response ) {
             work_uri = response.getResponseHeader( "Location" );
             ractive.set( "work_uri", work_uri );
           },
           function( response ) {
             console.log( "POST work error: " + response );
         });
       },
       function( response ) {
         console.log( "GET config error: " + response );
     });

    </script>
  </body>
</html>