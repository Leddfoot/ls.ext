<!DOCTYPE html>
<html>
  <head>
  	<meta charset="utf-8">
    <title>Katalogisering</title>
    <style type="text/css">
      body        { margin: 40px auto; max-width: 1050px; line-height: 1.6; padding: 0 10px;
                    font-family: sans-serif; font-size: 18px; color: #222; }
      h1, h2, h3  { line-height: 1.2 }
      fieldset    { border: 0; background: #eee;}
      input       { width: 300px; padding: 3px; margin: 0 }
      label       { font-family: monospace; text-align: right; width: 160px; display: inline-block; }

      #errors     { background: #F77F00; color: #fff; font-weight: bold; }
      #errors p   { padding: 4px; }

      #save-stat  { text-align: right; color: #888; margin: 0 4px; display: block; }
      #save-stat:before  { content: "status: ";}

      .prop-input   { clear:both ;}
      .prop-details { width: 20%; float: left; text-align: right;}
      .prop-values  { padding-left: 1em; max-width: 60%; float:left;}
      .link   { display:inline-block; width: 10px; height:10px; background-image: linear-gradient(transparent,transparent),url('data:image/svg+xml,<%3Fxml%20version%3D"1.0"%20encoding%3D"UTF-8"%3F><svg%20xmlns%3D"http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg"%20width%3D"10"%20height%3D"10"><g%20transform%3D"translate%28-826.429%20-698.791%29"><rect%20width%3D"5.982"%20height%3D"5.982"%20x%3D"826.929"%20y%3D"702.309"%20fill%3D"%23fff"%20stroke%3D"%2306c"%2F><g><path%20d%3D"M831.194%20698.791h5.234v5.391l-1.571%201.545-1.31-1.31-2.725%202.725-2.689-2.689%202.808-2.808-1.311-1.311z"%20fill%3D"%2306f"%2F><path%20d%3D"M835.424%20699.795l.022%204.885-1.817-1.817-2.881%202.881-1.228-1.228%202.881-2.881-1.851-1.851z"%20fill%3D"%23fff"%2F><%2Fg><%2Fg><%2Fsvg>'); }

      .invalid-input { border: 1px solid #F77F00;}
      .invalid-msg   { color: #F77F00; font-size: 12px;}

    </style>
    <script src="lib.js"></script>
  </head>
  <body>
    <div id="#container"></div>
    <script id="template" type="text/ractive">
      <h2>Katalogisering av verk</h2>
      <div id="errors">{{#errors}}<p>{{.}}</p>{{/errors}}</div>
      <div id="save-stat">{{save_status}}</div>
      <fieldset>
        <div class="prop-input">
          <div class="prop-details">
            <label>URI</label>
          </div>
          <div class="prop-values">
            <input disabled="disabled" data-automation-id="work_uri" value="{{work_uri}}"/>
            <a data-automation-id="work_page_link" target="_blank" href="{{work_uri.replace(':8005',':8000')}}" class="link"></a>
          </div>
        </div>
        {{#each inputs}}
          <div class="prop-input {{predicate}}">
            <div class="prop-details">
              <button on-click="addValue">+</button>
              <label>{{label}}</label>
            </div>
            <div class="prop-values">
              {{#each values}}
                {{#range === "http://www.w3.org/2001/XMLSchema#string"}}
                  {{>input-string}}
                {{elseif range === "http://www.w3.org/1999/02/22-rdf-syntax-ns#langString"}}
                  {{>input-lang-string}}
                {{elseif range === "http://www.w3.org/2001/XMLSchema#gYear"}}
                  {{>input-gYear}}
                {{elseif range === "http://www.w3.org/2001/XMLSchema#nonNegativeInteger"}}
                  {{>input-nonNegativeInteger}}
                {{else}}
                  {{>input-string}}
                {{/}}
                {{#predicate === "http://192.168.50.12:8005/ontology#biblio" && current.value !== ""}}
                  <a target="_blank" href="http://192.168.50.12:8080/cgi-bin/koha/opac-detail.pl?biblionumber={{current.value}}" class="link"></a>
                {{/}}
                <br/>
                <div class="invalid-msg">{{#error}}{{error}}{{/error}}</div>
              {{/each}}
            </div>
          </div>
        {{/each}}
      </fieldset>

      {{#partial input-string}}
          <input
            class="{{#error}}invalid-input{{else}}valid{{/error}}"
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            on-change="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
      {{/partial}}

      {{#partial input-lang-string}}
          <input
            class="{{#error}}invalid-input{{else}}valid{{/error}}"
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            on-change="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
            <select value="{{current.lang}}"
                    on-change='patchResource:{{predicate}}'
                    class="select_lang">
              <option value="">velg språk</option>
              <option value="no">norsk</option>
              <option value="en">engelsk</option>
              <option value="fr">fransk</option>
            </select>
      {{/partial}}

      {{#partial input-gYear}}
          <input
            class="{{#error}}invalid-input{{else}}valid{{/error}}"
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
      {{/partial}}

      {{#partial input-nonNegativeInteger}}
          <input
            class="{{#error}}invalid-input{{else}}valid{{/error}}"
            on-blur='patchResource:{{predicate}}'
            on-keyup="countdownToSave"
            on-change="countdownToSave"
            data-automation-id="{{predicate}}_{{@index}}"
            value="{{current.value}}" />
      {{/partial}}
    </script>
    <script src="http://cdn.ractivejs.org/latest/ractive.min.js"></script>
    <script>
      // TODO move this function to libs.js?
      function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
      };

      var errors = [];
      var ractive = new Ractive({
        el: "#container",
        lang: "no",
        template: "#template",
        data: {
          errors: errors,
          work_uri: "",
          inputs: {},
          ontology: null,
          save_status: "nytt verk"
        },
      });

      // Event handling functions responding to UI interactions:
      listener = ractive.on({
        countdownToSave: function( event ) {
          // TODO find better name to this function
          if ( event.context.current.value === "" && event.context.old.value === "" ) {
            return;
          }
          ractive.set("save_status", "arbeider...");
        },
        // addValue adds another input field for the predicate.
        addValue: function( event ) {
          ractive.get( event.keypath ).values.push({
            old: { value: "", type: "", lang: "" },
            current: { value: "", type: "", lang: "" }
          });
        },
        // patchResource creates a patch request based on previous and current value of
        // input field, and sends this to the backend.
        patchResource: function( event, predicate ) {
          if ( event.context.error || (event.context.current.value === "" && event.context.old.value === "" ) ) {
            return;
          }
          var patch = rdf.createPatch( ractive.get("work_uri"), predicate, event.context );
          http.patch(ractive.get("work_uri"),
            {"Accept": "application/ld+json", "Content-Type":"application/ldpatch+json"},
            patch,
            function( response) {
              // successfully patched resource

              // keep the value in current.old - so we can do create delete triple patches later
              var cur = ractive.get(event.keypath+".current");
              ractive.set( event.keypath+".old.value", cur.value );
              ractive.set( event.keypath+".old.lang", cur.lang );
              ractive.set( event.keypath+".old.datatype", cur.datatypr );

              ractive.set("save_status", "alle endringer er lagret");
            },
            function( response) {
              // failed to patch resource
              errors.push( "Noe gikk galt! Fikk ikke lagret endringene" )
            });
        }
      });

      // Observing input for instant validation:
      ractive.observe("inputs.*.values.*", function(newValue, oldValue, keypath) {
        if ( newValue.current.value === "" ) {
          ractive.set( keypath+".error", false );
          return;
        }
        var parent = keypath.substr(0, keypath.substr(0,keypath.lastIndexOf(".")).lastIndexOf("."));
        var valid = false;
        try {
          valid = rdf.validateLiteral(newValue.current.value, ractive.get(parent).range);
        } catch (e) {
          console.log(e);
          return;
        }
        if (valid ) {
          ractive.set( keypath+".error", false );
        } else {
          ractive.set( keypath+".error", "ugyldig input" );
        }
      });

      // Application entrypoint - will fetch any resources (ontology etc) required to populate the UI.
      http.get("/config", {"Accept": "application/ld+json"},
        function( response ) {
          cfg = JSON.parse( response.responseText );

          // fetch ontology
          http.get(cfg.ontologyUri, {"Accept": "application/ld+json"},
            function( response ) {
              var ontology = JSON.parse( response.responseText ),
                  props = rdf.propsByClass( ontology, "Work" ),
                  inputs = [];

              ractive.set( "ontology", ontology );

              for ( var i=0; i<props.length; i++ ) {
                inputs.push({
                  predicate: rdf.resolveURI( ontology,  props[i]["@id"]),
                  range: props[i]["rdfs:range"]["@id"],
                  label:props[i]["rdfs:label"][0]["@value"],
                  values: [{old: { value: "", type: "", lang: "" },
                            current: { value: "", type: "", lang: "" }}]
                });
              }
              ractive.set( "inputs", inputs );
            },
           function( response ) {
             console.log( "GET ontology error: " + response );
          });

        // If resource URI is given in query string, it will be loaded for editing, otherwise we will
        // request a new URI for working on a new resource.
        var uri = getURLParameter("resource");
        if (uri) {
          // load existing resource
          http.get(cfg.resourceApiUri + "work/"+uri.substr(uri.lastIndexOf("/")+1),
            {"Accept": "application/ld+json"},
            function(response) {
              ractive.set("work_uri", uri);
              var values = rdf.extractValues(JSON.parse(response.responseText));
              for ( var n in ractive.get("inputs") ) {
                var kp = "inputs." + n;
                var input = ractive.get(kp);
                if ( values[input.predicate] ) {
                  ractive.set(kp+".values", values[input.predicate]);
                }
              }

              ractive.set("save_status", "åpnet eksisterende verk");
            },
            function(response) {
              console.log(response);
            });
        } else {
          // fetch URI for work
          http.post(cfg.resourceApiUri + "work",
            {"Accept": "application/ld+json", "Content-Type":"application/ld+json"},
             "{}",
            function( response ) {
              work_uri = response.getResponseHeader( "Location" );
              ractive.set( "work_uri", work_uri );
            },
            function( response ) {
              console.log( "POST work error: " + response );
          });
        }
       },
       function( response ) {
         console.log( "GET config error: " + response );
     });

    </script>
  </body>
</html>